<html>
<head>
  <script type="application/javascript">

    function getRndInteger(min, max) {
      return Math.floor(Math.random() * (max - min) ) + min;
    }

    var img = new Image();
    img.src = "4-tree-png-image-download-picture.png";

    // Canvas Setup
    const CanvasWidth = 800, CanvasHeight = 600;
    const HalfCanvasWidth = CanvasWidth / 2, HalfCanvasHeight = CanvasHeight / 2;

    // Box object in the 3D world coord
    const BoxWidth = 100, BoxHeight = 170;
    const NumBoxes = 15;

    const Game = {};
    const world = [];
    
    // Boxes Generation
    for (let i = 0; i < NumBoxes; i++) {
        world.push([-150 + getRndInteger( 0, 300), /* x */                   
        0, /* y */
        getRndInteger( 30, 250), /* z */
        BoxWidth + getRndInteger( 0, 20),
        BoxHeight + getRndInteger( 0, 20)]);
    }

    var cameraPosition = [0 /* x */, 60 /* y */, 0 /* z */];

    // Focal length of the camera in 3D world space
    const FocalLength = 10;
    
    var tickLength = 50;
    var ctx;

    function GameLoop() {

        Game.stopMain = window.requestAnimationFrame( GameLoop );

        // statistics
        currTick = performance.now();

        // skip rendering to slow down the frame update
        if (Game.lastTick + tickLength > currTick) return;

        moveCamera(0, 0, 1.5);
        draw();        

        let fps = 1000 / (currTick - Game.lastTick);
        Game.lastTick = currTick;
        ctx.fillText('FPS: ' + fps.toFixed(2), -400, -280);        
    }

    function init() {

      // keyboard control
      window.addEventListener("keydown", event => {
        switch (event.key) {
          case 'ArrowUp':
            moveCamera(0, -5, 0);
          break;
          case 'ArrowDown':
            moveCamera(0, 5, 0);
          break;
          case 'ArrowLeft':
            moveCamera(-10, 0, 0);
          break;
          case 'ArrowRight':
            moveCamera(10, 0, 0);
          break;
        }
      }, true);


      ctx = document.getElementById("canvas").getContext("2d");

      // canvas to camera space
      ctx.translate(HalfCanvasWidth, HalfCanvasHeight);

      Game.lastTick = performance.now();
      GameLoop(); // Start the cycle
    }

    function moveCamera(dx, dy, dz) {

      cameraPosition[0] += dx;
      cameraPosition[1] += dy;
      cameraPosition[2] += dz;
    }

    function drawBox(box) {

      let [bx, by, bz, boxWidth, boxHeight] = box;
      let [cx, cy, cz] = cameraPosition;

      if ((bz - cz) > 0) {

        let scale = FocalLength/ (bz - cz);

        ctx.save();

        // world to camera space
        ctx.scale(scale, scale);

        ctx.drawImage(img, bx - cx - boxWidth / 2, by - cy - boxHeight / 2, boxWidth, boxHeight);
        // draw the bounding box
//         ctx.strokeStyle = "rgb(200, 0, 0)";
//         ctx.strokeRect(bx - cx - boxWidth / 2, by - cy - boxHeight / 2, boxWidth, boxHeight);
        
        ctx.restore();

      } else {

        world.splice(world.indexOf(box), 1);
        world.push([-150 + getRndInteger( 0, 300), /* x */                   
         0, /* y */
         cz + getRndInteger( 30, 250), /* z */
         BoxWidth + getRndInteger( 0, 20),
         BoxHeight + getRndInteger( 0, 20)]);
      }
    }

    function draw() {

      // clear canvas
      ctx.clearRect(-HalfCanvasWidth, -HalfCanvasHeight, CanvasWidth, CanvasHeight);

      // draw objects in the world
      world.sort((a, b) => b[2] - a[2]);
      world.forEach(obj =>  drawBox(obj));

      // draw the center cross lines on overlay
      ctx.strokeStyle = "rgb(100, 100, 0)";
      ctx.moveTo(0, HalfCanvasHeight);
      ctx.lineTo(0, -HalfCanvasHeight);
      ctx.moveTo(-HalfCanvasWidth, 0);
      ctx.lineTo(HalfCanvasWidth, 0);
      ctx.stroke();
    }

  </script>
</head>
<body onload="init();">
 <center>
   <b1>2.5D Simple Example</b1>
   <br>
   <canvas id="canvas" width="800" height="600"></canvas>
   <br>   
   <a href="javascript:moveCamera(-5, 0, 0);">Left</a>
   <a href="javascript:moveCamera(5, 0, 0);">Right</a>
   <a href="javascript:moveCamera(0, -5, 0);">Up</a>
   <a href="javascript:moveCamera(0, 5, 0);">Down</a>
 </center>
</body>
</html>